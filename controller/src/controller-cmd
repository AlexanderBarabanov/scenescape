#!/usr/bin/env python3

# SPDX-FileCopyrightText: (C) 2024 - 2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

import argparse
import os
import threading
from http.server import BaseHTTPRequestHandler, HTTPServer

from controller.scene_controller import SceneController
from controller.controller_mode import ControllerMode
from controller.observability import metrics, tracing

class HealthCheckHandler(BaseHTTPRequestHandler):
  def __init__(self, *args, **kwargs):
    super().__init__(*args, **kwargs)

  def do_GET(self):
    if self.path == '/healthz' or self.path == '/health':
      # Add logic to check if controller is healthy
      # For now, just return 200 if running
      self.send_response(200)
      self.send_header('Content-type', 'text/plain')
      self.end_headers()
      self.wfile.write(b'OK')
    else:
      self.send_response(404)
      self.end_headers()

  def log_message(self, format, *args):
    # Suppress logging of health check requests
    pass

def start_health_server(port):
  handler = lambda *args, **kwargs: HealthCheckHandler(*args, **kwargs)
  server = HTTPServer(('0.0.0.0', port), handler)
  thread = threading.Thread(target=server.serve_forever, daemon=True)
  thread.start()
  return server

def build_argparser():
  parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
  parser.add_argument("--rewriteBadTime", action="store_true",
                      help="Rewrite bad time stamps instead of discarding data")
  parser.add_argument("--rewriteAllTime", action="store_true",
                      help="Rewrite all time stamps")
  parser.add_argument("--maxlag", help="Maximum amount of lag in seconds",
                      default=1.0, type=float)

  # FIXME - configure mosquitto to authenticate against REST so that
  # same user/pass can be used for both REST and MQTT
  # https://pypi.org/project/django-mqtt/
  parser.add_argument("--broker", default="broker.scenescape.intel.com:1883",
                      help="hostname or IP of MQTT broker, optional :port")
  parser.add_argument("--brokerauth", default="/run/secrets/controller.auth",
                      help="user:password or JSON file for MQTT authentication")
  parser.add_argument("--resturl", default="https://web.scenescape.intel.com/api/v1",
                      help="URL of REST server")
  parser.add_argument("--restauth", help="user:password or JSON file for REST authentication")
  parser.add_argument("--rootcert", default="/run/secrets/certs/scenescape-ca.pem",
                      help="path to ca certificate")
  parser.add_argument("--cert", help="path to client certificate")
  parser.add_argument("--data_source", nargs="+", help="List of scene json files")
  parser.add_argument("--verbose", action="store_true",
                      help="lots and lots of debug printing")
  parser.add_argument("--ntp", help="NTP server, default is to use mqtt broker")
  script_path = os.path.abspath(__file__)
  parser.add_argument("--tracker_config_file", help="JSON file with tracker configuration for time-based parameters",
            default=os.path.join(os.path.dirname(script_path), "tracker-config.json"))
  parser.add_argument("--schema_file", help="JSON file with metadata schema",
            default=os.path.join(os.path.dirname(script_path), "schema/metadata.schema.json"))
  parser.add_argument("--visibility_topic", help="Which topic to publish visibility on."
                      "Valid options are 'unregulated', 'regulated', or 'none'",
                      default="regulated")
  parser.add_argument("--healthcheck_port", type=int, default=0,
                      help="Port for HTTP health check endpoint (0 to disable)")
  parser.add_argument("--analytics-only", action="store_true",
                      default=os.getenv("CONTROLLER_ENABLE_ANALYTICS_ONLY") == "true",
                      help="Enable analytics-only mode. Use this when running a separate Tracker service that publishes tracking data to MQTT.")
  return parser

def main():
  args = build_argparser().parse_args()

  ControllerMode.initialize(analytics_only=args.analytics_only)

  metrics.init()
  tracing.init()
  controller = SceneController(args.rewriteBadTime, args.rewriteAllTime,
                              args.maxlag, args.broker,
                              args.brokerauth, args.resturl,
                              args.restauth, args.cert,
                              args.rootcert, args.ntp, args.tracker_config_file, args.schema_file,
                              args.visibility_topic, args.data_source)

  # Start health check server if port is specified
  if args.healthcheck_port > 0:
    start_health_server(args.healthcheck_port)

  controller.loopForever()

  return

if __name__ == '__main__':
  exit(main() or 0)
