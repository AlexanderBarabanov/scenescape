# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-stability"
  annotations:
    "helm.sh/hook": test
spec:
  serviceAccountName: {{ .Release.Name }}-stability-test
  containers:
    - name: stability
      image: bitnami/kubectl:latest
      command: ['/bin/sh', '-c']
      args:
        - |
          set -e

          echo "Checking initial pod status..."
          kubectl get pod -n {{ .Release.Namespace }} -o json \
            | jq -r '.items[] | select(.metadata.labels["meta.helm.sh/release-namespace"] == "{{ .Release.Namespace }}" and .metadata.labels["meta.helm.sh/release-name"] == "{{ .Release.Name }}") | .metadata.name as $pod | .status.containerStatuses[] | $pod + " " + .name + " " + (.restartCount|tostring)' \
            | sort \
            > /tmp/pod_list

          sleep 120

          kubectl get pod -n {{ .Release.Namespace }} -o json \
            | jq -r '.items[] | select(.metadata.labels["meta.helm.sh/release-namespace"] == "{{ .Release.Namespace }}" and .metadata.labels["meta.helm.sh/release-name"] == "{{ .Release.Name }}") | .metadata.name as $pod | .status.containerStatuses[] | $pod + " " + .name + " " + (.restartCount|tostring)' \
            | sort \
            > /tmp/pod_list_after

          if diff /tmp/pod_list /tmp/pod_list_after > /tmp/pod_diff; then
            echo "No changes in container restart counts"
            exit 0
          else
            echo "Detected changes in container restart counts:"
            cat /tmp/pod_diff
            exit 1
          fi
      volumeMounts:
        - name: tmp
          mountPath: /tmp
  restartPolicy: Never
  volumes:
    - name: tmp
      emptyDir: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Name }}-stability-test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Release.Name }}-stability-test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Release.Name }}-stability-test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
subjects:
  - kind: ServiceAccount
    name: {{ .Release.Name }}-stability-test
roleRef:
  kind: Role
  name: {{ .Release.Name }}-stability-test
  apiGroup: rbac.authorization.k8s.io
